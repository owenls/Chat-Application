{% extends 'base.html' %} {% block title %} {{ room.description}}  {% endblock %}

{% block mycss %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/room.css') }}"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% endblock mycss %} 

{% block content %}

<div class="content">
  <div class="message-box">
    <div class="container-fluid" id="title-and-searchBar">
      <div class="row">
        <div class="col-9" id="title">
          <h2>Chat Room: {{room.room_name}}</h2>
        </div>
        <div class="col" id="search">
          <form id="searchBarContainer">
            <input id="searchBar" type="text" name="query" placeholder="&#128269; Search all messages or type ./from to search by user" autocomplete="off">
            <input type="hidden" name="room_id" value="{{room.id}}">
            <button type="submit"><i class="fa fa-search"></i></button>
          </form>
          <div class="result-box" id="search-results">   </div>
        </div>
      </div>

        
        <div class="container-fluid" id="inner-content">
          <div class="row">
            <div class="members-list" class="col-4">
              <div  id="membersList">
                <h5 title="Users currently in the chat">Active Members</h5>
                <hr class="greyHR">
                <!-- ActiveMembers of a chat room are inserted into this div-->
              </div>
              <div id="commandsDiv">
                <hr class="bottomHR">
                <h6>Commands</h6>
                <p class="commands">./scramble [Category]</p>
                <p style="text-align:center;">Categories: fruit, videogames, css</p>
                <!-- <ul>
                  <li>fruit</li>
                  <li>videogames</li>
                  <li>css</li>
                </ul> -->
              </div>
            </div>
            


        <div class="col">
          <div id="chat-feed-and-input">
            <div id="clock">Time left = <span id="timer"></span></div>
            <div class="messages" id="messages"></div>
            <div class="input" id="type-and-send">
              <input type="text" rows="3" placeholder="&#128233; Message" name="message" id="message">
              <div class="dropdown">
                <button class="dropdown-toggle" type="button" id="toggle-dropdown-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-wrench"></i>
                </button>
                <div class="dropdown-menu" aria-labelledby="toggle-dropdown-btn">
                  <button class="dropdown-item" id="toggle-members-btn">Toggle Members</button>
                  <button class="dropdown-item" id="dark-mode-toggle-btn">Toggle Dark Mode</button>
                </div>
              </div>
              <button name="send" id="send-btn" onclick="sendMessage()">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
var socketio = io();
var questionBotActive = true;
var myUsername = "{{ user.username }}";
// Add more questions to test
var questions = [
  {
    question: "Who is the main character of the hit anime series Naruto?",
    options: ["A: Iron Man", "B: Naruto"],
    answer: "B"
  },
  {
    question: "Who was in Paris?",
    options: ["A: Nice Gentlemen", "B: Owen"],
    answer: "A"
  },
  {
    question: "What is the Unit Coordinators Name?",
    options: ["A: John Lumagbas", "B: Tim French", "B: Jin Hong"],
    answer: "B"
  },
  {
    question: "Who is the current President of the USA?",
    options: ["A: John F Kennedy", "B: Joe Biden", "C: Xi Jinping"],
    answer: "B"
  },
  {
    question: "What animal can be found in the UWA Crest?",
    options: ["A: Eagle", "B: Lion", "C: Swan"],
    answer: "C"
  },
  {
    question: "Who was NOT in Paris?",
    options: ["A: Nice Gentlemen", "B: Owen",],
    answer: "B"
  }
];

socketio.on("message", (data) => {
  // If the "stop_question" message is received from the user, deactivate the bot
  if (data.message === "stop_question") {
    questionBotActive = false;
    return;
  }

  // If the "ask_question" message is received from the user and the bot is active
  if (data.message === "ask_question" && questionBotActive) {
  setTimeout(() => {
    // Select a random question
    const randomIndex = Math.floor(Math.random() * questions.length);
    const selectedQuestion = questions[randomIndex];

    // Store the answer in a variable
    const answer = selectedQuestion.answer;

    // Generate the question message
    const questionMessage = `
      <div class="message-container bot-message">
        <div class="message-content">
          <div class="username"><strong>Questionnaire Bot</strong></div>
          <div class="message-text">${selectedQuestion.question}</div>
          <div class="message-text">${selectedQuestion.options.join(" ")}</div>
        </div>
      </div>
    `;

    // Display the question to all users
    document.getElementById("messages").innerHTML += questionMessage;
    messages.scrollTop = messages.scrollHeight;

    // Store the answer for later comparison
    sessionStorage.setItem("currentAnswer", answer);
  }, 100); // 100ms delay
}

// Check if a user answered the question correctly and the bot is active
if (["A", "B", "C"].includes(data.message) && questionBotActive) {
  setTimeout(() => {
    // Retrieve the stored answer
    const storedAnswer = sessionStorage.getItem("currentAnswer");

    // Check if the user's answer matches the stored answer
    if (data.message === storedAnswer) {
      const answerMessage = `
        <div class="message-container bot-message">
          <div class="message-content">
            <div class="username"><strong>Questionnaire Bot</strong></div>
            <div class="message-text">Correct answer!</div>
          </div>
        </div>
      `;

      // Display the answer message to all users
      document.getElementById("messages").innerHTML += answerMessage;
      messages.scrollTop = messages.scrollHeight;
    }
  }, 100); // 100ms delay
}
});

// Add a listener for when you submit an answer
document.getElementById("your-answer-submit-button-id").addEventListener("click", function() {
  const answerInput = document.getElementById("your-answer-input-id").value;
  if (answerInput === "A" && questionBotActive) {
    const answerMessage = `
      <div class="bot-message">
        <div class="message-content">
          <span><strong>Questionnaire Bot</strong>: Correct answer!</span>
        </div>
      </div>
    `;

    // Display the answer message in your view
    document.getElementById("messages").innerHTML += answerMessage;
  }
});
</script>


// Event listener for settings
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    const toggleMembersButton = document.querySelector('#toggle-members-btn');
    const darkModeToggleBtn = document.querySelector('#dark-mode-toggle-btn');
    const membersList = document.querySelector('.members-list');
    const body = document.body;
    const messages = document.getElementById('messages');

    toggleMembersButton.addEventListener('click', () => {
      membersList.classList.toggle('hidden');
    });

    darkModeToggleBtn.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      messages.classList.toggle('dark-mode');
    });
  });
</script>
<script>
  


  var socketio = io();

  const messages = document.getElementById("messages");
  const members_list = document.getElementById("membersList");


  const addMember = (username, profile_picture) => {
    const content = `
      <div>
        <span class="one-user" id="${username}">
          <img src="${profile_picture}" alt="Profile Picture" width="50" height="50" style="border-radius: 50%;"> <strong>${username}</strong>
        </span>
      </div>
    `;
    members_list.innerHTML += content;
  }

  function removeItem( itemID ){
    let element = document.getElementById(itemID);
    element.parentNode.removeChild(element);
  }

  var myUsername = "{{ user.username }}"
  const createMessage = (username, msg, profile_picture, date) => {
    const messageType = (username === myUsername) ? "my-message" : "other-message";
    const content = `
        <div class="${messageType}">
            <img src="${profile_picture}" alt="Profile Picture" width="50" height="50" style="border-radius: 50%;">
            <div class="message-content">
                <span class="date" style="font-size: 0.8em; display: block;">${date}</span>
                <span><strong>${username}</strong>: ${msg}</span>
            </div>
        </div>
    `;
    messages.innerHTML += content;

    // Scroll to bottom after posting message
    messages.scrollTop = messages.scrollHeight;
};

  

  socketio.on("message", (data) =>{
        if(!(typeof data.all_member_usernames === "undefined"))
        {
            //This has to be a new connection to the room. (only message parsed without a date)
            addMember(data.username, data.profile_picture);
            for(i=0; i < data.all_member_usernames.length; i++){
              let myEle = document.getElementById(data.all_member_usernames[i]);
              if(!myEle) { //If they're not in the list add them.
                addMember(data.all_member_usernames[i], data.all_member_profiles[i]);
              }
            }

        }
        createMessage(data.username, data.message, data.profile_picture, data.date);

        if (data.message.includes("Unscramble this word:") && data.username == "CP"){
          if(data.message.includes("Round 1")){
            saveContent();
          }
          i = data.message.lastIndexOf(': ');
          hideCommands(data.message.slice(i+2));
          callTimer();

        }else if (data.message.includes("is CORRECT") && data.username == "CP"){
            stopTimer();
        }else if(data.message.includes("Game Over!") || data.message.includes("No Winner")){
            showCommands();
        }
        if(data.gameMode == "ON"){
          //The timer is not stored in the database so showTimer has nothing to show.
          // showTimer();f

        }
        
        if(!(typeof data.disconnecting === "undefined"))
        {
          removeItem(data.username);
        }

      });

  const sendMessage = () => {
      const message = document.getElementById("message")
      if (message.value == "") return;
      socketio.emit("new-message", {data: message.value}) //This is an event called new-message, altering the name allows more complicated things.
      message.value = ""; 
  };
</script>


<!-- Loads all of the previous messages on loading into the room -->
{% for msg, username, profile_picture in messages %}
    <script>
        createMessage("{{ username }}", "{{ msg.data }}", "{{ profile_picture }}", "{{ msg.date}}");
    </script>
{% endfor %}


<!-- Adds the ability to just click enter and not have to press "Send" button for messages -->
<script>
    var input = document.getElementById("message");
    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("send-btn").click();
      }
    });
</script>

{% endblock %}

{% block bottom_script %} 
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
  var searchBar = $('#searchBar');
  var resultsBox = $('#search-results');

  searchBar.on('keyup', function(event) {
    var query = $('input[name="query"]').val();
    var room_id = $('input[name="room_id"]').val();
    $.ajax({
      url: "{{ url_for('auth.search_messages') }}",
      data: {query: query, room_id: room_id},
      success: function(data) {
        resultsBox.html(data);
      }
    });
  });
  
  //Highlight and Search word in search bar
  searchBar.on('click', function() {
    searchBar.trigger('keyup');
    this.select();
  });
  

  //Search results dissapear when clicking elsewhere
  $(document).on('click', function(event) {
    if (!searchBar.is(event.target) && searchBar.has(event.target).length === 0 &&
        !resultsBox.is(event.target) && resultsBox.has(event.target).length === 0) {
      resultsBox.html('');
    }
  });
});


function callTimer(){
    document.getElementById('timer').innerHTML = 0 + ":" + 5;
    document.getElementById("clock").style.visibility = "visible";
    document.getElementById("timer").style.visibility = "visible"; 
    document.getElementById("clock").style.height = "10%";
    startTimer();
}

function startTimer() {
    var presentTime = document.getElementById('timer').innerHTML;
    var timeArray = presentTime.split(/[:]+/);
    var m = timeArray[0];
    var s = checkSecond((timeArray[1] - 1));
    if(s==59){m=m-1}
        if(m<0){
            //Hides the elements when the timer runs out.
            document.getElementById("clock").style.visibility = "hidden";
            document.getElementById("timer").style.visibility = "hidden";
            document.getElementById("clock").style.height = 0;
            socketio.emit("scramble-timer-done");
            return
        }
    document.getElementById('timer').innerHTML = m + ":" + s;
    timerTimeout = setTimeout(startTimer, 1000);
    
    }

    function stopTimer() {
        document.getElementById("clock").style.visibility = "hidden";
        document.getElementById("timer").style.visibility = "hidden";
        document.getElementById("clock").style.height = 0;
        clearTimeout(timerTimeout);
      }

    //Called when a user joins and the game has already begun.
    function showTimer() {
      document.getElementById("clock").style.visibility = "visible";
      document.getElementById("timer").style.visibility = "visible";
      var currentTime = document.getElementById("timer").innerHTML;
      document.getElementById("current-time").innerHTML = "Time: " + currentTime;
    }

    function checkSecond(sec) {
    if (sec < 10 && sec >= 0) {sec = "0" + sec}; // add zero in front of numbers < 10
    if (sec < 0) {sec = "59"};
    return sec;
    }

    let commandsContent;


    //These are used if we want to insert a new div, but I might revert to just adding the word under the timer.
    function hideCommands(word){
      const newContent = `
      <div id="scrambleWordDiv">
        <hr class="bottomHR">
        <span id="scrambleWord">Current Word: ${word}</span>
      </div>
      `
      document.getElementById("commandsDiv").innerHTML = newContent;
    }

    function saveContent(){
      commandsContent = document.getElementById("commandsDiv").innerHTML; //Save content before overwriting it.
    }
    function showCommands(){
      document.getElementById("commandsDiv").innerHTML = commandsContent;
    }

</script>

{% endblock bottom_script %}

<!-- <script src="{{ url_for('static', filename='js/chat.js') }}"></script> -->